# ๐ ะกัััะบัััะฐ Aggregator Service

---

```bash
Aggregator/
โโโ src/
โ   โโโ api/
โ   โ   โโโ __init__.py
โ   โ   โโโ routes.py        # REST/GraphQL ัััะบะธ ะดะปั ะพะฑัะตะฝะธั ั Gateway
โ   โ
โ   โโโ core/
โ   โ   โโโ config.py        # ะะฐัััะพะนะบะธ (env, ะบะพะฝััะฐะฝัั)
โ   โ   โโโ logger.py        # ะะพะณะธัะพะฒะฐะฝะธะต
โ   โ   โโโ utils.py         # ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะธะปะธัั
โ   โ
โ   โโโ services/
โ   โ   โโโ dispatcher.py    # ะัะฟัะฐะฒะบะฐ ะทะฐะดะฐั ะฒ ะพัะตัะตะดั ะดะปั ัะบัะฐะฟะฟะตัะพะฒ
โ   โ   โโโ aggregator.py    # ะะณัะตะณะฐัะธั ะพัะฒะตัะพะฒ ะพั ัะบัะฐะฟะฟะตัะพะฒ
โ   โ   โโโ tracker.py       # ะััะปะตะถะธะฒะฐะฝะธะต ััะฐัััะฐ (ะบะฐะบะธะต ัะบัะฐะฟะฟะตัั ัะถะต ะพัะฒะตัะธะปะธ)
โ   โ
โ   โโโ consumers/
โ   โ   โโโ scraper_consumer.py  # ะกะปััะฐะตั ะพัะตัะตะดั ั ัะตะทัะปััะฐัะฐะผะธ ะพั ัะบัะฐะฟะฟะตัะพะฒ
โ   โ   โโโ __init__.py
โ   โ
โ   โโโ models/
โ   โ   โโโ request.py       # Pydantic-ะผะพะดะตะปะธ: SearchRequest, SearchResult
โ   โ   โโโ response.py
โ   โ
โ   โโโ main.py              # ะขะพัะบะฐ ะฒัะพะดะฐ (FastAPI + consumers ะทะฐะฟััะบ)
โ
โโโ tests/                   # ะขะตััั (unit + integration)
โ   โโโ test_api.py
โ   โโโ test_dispatcher.py
โ   โโโ test_aggregator.py
โ
โโโ dockerfile
โโโ docker-compose.yml
โโโ requirements.txt
โโโ README.md
```

---

# โ๏ธ ะะพะณะธะบะฐ ัะฐะฑะพัั

1. **Gateway โ Aggregator**
    
    - ะัะธัะพะดะธั ะทะฐะฟัะพั ะฟะพะธัะบะฐ (`search: "ะฐะนัะพะฝ"`, `categories: ["phones"]`).
        
    - ะัะบะตัััะฐัะพั ัะพะทะดะฐัั `request_id`.
        
2. **Dispatcher**
    
    - ะะปะฐะดัั ะทะฐะดะฐัะธ ะฒ ะพัะตัะตะดั (ะฝะฐะฟัะธะผะตั, RabbitMQ) ะดะปั ะบะฐะถะดะพะณะพ ะฝัะถะฝะพะณะพ ัะบัะฐะฟะฟะตัะฐ.
        
    - ะ ะทะฐะดะฐัะต: `request_id`, `query`, `filters`.
        
3. **Scrapers โ Aggregator (Consumer)**
    
    - ะกะบัะฐะฟะฟะตัั ะฒะพะทะฒัะฐัะฐัั ัะตะทัะปััะฐัั ั ััะธะผ `request_id`.
        
    - Consumer ัะปััะฐะตั ะพัะตัะตะดั ะธ ะฟะตัะตะดะฐัั ะดะฐะฝะฝัะต ะฒ `aggregator`.
        
4. **Aggregator**
    
    - ะกะพะฑะธัะฐะตั ะฒัะต ะพัะฒะตัั ะฟะพ `request_id`.
        
    - ะะฝะฐะตั ัะฟะธัะพะบ ะพะถะธะดะฐะตะผัั ัะบัะฐะฟะฟะตัะพะฒ (ะฝะฐะฟัะธะผะตั, `ozon`, `wb`, `avito`).
        
    - ะัะปะธ ะฒัะต ะพัะฒะตัะธะปะธ ะธะปะธ ะฒััะตะป timeout โ ะพัะดะฐัั ัะตะทัะปััะฐั ะบะปะธะตะฝัั.
        
5. **Tracker**
    
    - ะะตะดัั ัะพััะพัะฝะธะต ะฟะพ ะบะฐะถะดะพะผั ะทะฐะฟัะพัั:
        
        - ะบะฐะบะธะต ัะบัะฐะฟะฟะตัั ัะถะต ะพัะฒะตัะธะปะธ
            
        - ัะบะพะปัะบะพ ะตัั ะถะดัะผ
            
        - ััะฐััั (`in_progress`, `done`, `timeout`).
            

---

# ๐ ะะธะฝะธ-ER ััะตะผะฐ ะฒ ะฟะฐะผััะธ

- **SearchRequest**
    
    - `request_id: str`
        
    - `query: str`
        
    - `status: str (in_progress/done/timeout)`
        
    - `expected_scrapers: list[str]`
        
    - `received_scrapers: list[str]`
        
    - `results: list[Product]`
        
- **Product**
    
    - `title: str`
        
    - `price: float`
        
    - `url: str`
        
    - `source: str (ozon/wb/avito)`
        

---

